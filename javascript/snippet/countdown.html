<!doctype html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Timer</title>

<style>
    .countdown_wrap{
        display:flex;
    }
    .countdown_item{
        position: relative;
        min-width: 50px;
    }
    .countdown_data{
        position: relative;
        display: block;
        font-weight: bold;
        font-size: 1.4rem;
        text-align: center;
    }
    .countdown_unit{
        position: absolute;
        display: block;
        font-size: 10px;
        width:100%;
        text-align: center;
        left:0;
        bottom: -15px;
        color:#999999;
    }
    .countdown_sep{
        font-size: 1.2rem;
        margin-left: 5px;
        margin-right: 5px;
        display: none;
    }

</style>
</head>
<body>

<div id="countdown_vueapp">

    <div v-if="countdown._passed==true">
        <p>PASSED</p>
    </div>
    <div v-else class="countdown_wrap">
        <div class="countdown_item countdown_item--y" v-if="timer.y>=1">
            <span class="countdown_data countdown_data--y">{{ timer.y }}</span>
            <span class="countdown_unit countdown_unit--y">years</span>
            <span class="countdown_sep countdown_sep--ym">/</span>
        </div>
        <div class="countdown_item countdown_item--m" v-if="timer.y>=1 || timer.m>=1">
            <span class="countdown_data countdown_data--m">{{ timer.m | zerofill }}</span>
            <span class="countdown_unit countdown_unit--m">months</span>
            <span class="countdown_sep countdown_sep--md">/</span>
        </div>
        <div class="countdown_item countdown_item--d" v-if="timer.y>=1 || timer.m>=1 || timer.d>=1">
            <span class="countdown_data countdown_data--d">{{ timer.d | zerofill }}</span>
            <span class="countdown_unit countdown_unit--d">days</span>
            <span class="countdown_sep countdown_sep--mh">-</span>
        </div>
        <div class="countdown_item countdown_item--h" v-if="timer.y>=1 || timer.m>=1 || timer.d>=1 || timer.h>=1">
            <span class="countdown_data countdown_data--h">{{ timer.h | zerofill }}</span>
            <span class="countdown_unit countdown_unit--h">hours</span>
            <span class="countdown_sep countdown_sep--hi">:</span>
        </div>
        <div class="countdown_item countdown_item--i" v-if="timer.y>=1 || timer.m>=1 || timer.d>=1 || timer.h>=1 || timer.i>=1">
            <span class="countdown_data countdown_data--i">{{ timer.i | zerofill }}</span>
            <span class="countdown_unit countdown_unit--i">minutes</span>
            <span class="countdown_sep countdown_sep--is">:</span>
        </div>
        <div class="countdown_item countdown_item--s">
            <span class="countdown_data countdown_data--s">{{ timer.s | zerofill }}</span>
            <span class="countdown_unit countdown_unit--s">seconds</span>
        </div>
    </div>

</div>


<script src="./js/vendor/polyfills.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://momentjs.com/downloads/moment.min.js"></script>



<script>
    let countdown_moment = moment('2020-04-18 18:49:00');
    let countdown_anime_request;
    let countdown_interval = 30;
    let countdown_frame_cnt = 0;

    Vue.filter('zerofill', function (value) {
        if (!value) return '00';
        if(value <= 9){
            return "0" + value.toString();
        }
        return value.toString();
    });
    let countdown_vueapp = new Vue({
        el: '#countdown_vueapp',
        data: {
            'countdown': {
                '_passed': false,
            },
            'timer': {
                'y': 0,
                'm': 0,
                'd': 0,
                'h': 0,
                'i': 0,
                's': 0,
            },
        },
        methods: {
            updateTime: function () {
                let now = moment();
                // console.log(now.format("YYYY-MM-DD hh:mm:ss"));
                // console.log(countdown_moment.format("YYYY-MM-DD hh:mm:ss"));
                // console.log(countdown_moment);
                // console.log(now.isSameOrBefore(countdown_moment));
                if(now.isSameOrBefore(countdown_moment)){
                    // まだ
                    let diff_y = countdown_moment.diff(now, 'years');
                    let diff_m = countdown_moment.diff(now, 'months') - (diff_y * 12);
                    let diff_d = countdown_moment.diff(now, 'days') - (diff_y * 12 * now.daysInMonth()) - ((diff_m) * now.daysInMonth());
                    let diff_h = countdown_moment.diff(now, 'hours') - (diff_y * 12 * now.daysInMonth() * 24) - ((diff_m) * now.daysInMonth() * 24) - (diff_d * 24);
                    let diff_i = countdown_moment.diff(now, 'minutes') - (diff_y * 12 * now.daysInMonth() * 24 * 60) - ((diff_m) * now.daysInMonth() * 24 * 60) - (diff_d * 24 * 60) - (diff_h * 60);
                    let diff_s = countdown_moment.diff(now, 'seconds') - (diff_y * 12 * now.daysInMonth() * 24 * 60 * 60) - ((diff_m) * now.daysInMonth() * 24 * 60 * 60) - (diff_d * 24 * 60 * 60) - (diff_h * 60 * 60) - (diff_i * 60);
                    // console.log('goal',countdown_moment.format("YYYYMMDD hh:mm:ss"));
                    // console.log('now',now.format("YYYYMMDD hh:mm:ss"));
                    // console.log('diff_y',diff_y);
                    // console.log('diff_m',diff_m);
                    // console.log('diff_d',diff_d);
                    // console.log('diff_h',diff_h);
                    // console.log('diff_i',diff_i);
                    // console.log('diff_s',diff_s);
                    this.$set(this.timer, 'y', diff_y);
                    this.$set(this.timer, 'm', diff_m);
                    this.$set(this.timer, 'd', diff_d);
                    this.$set(this.timer, 'h', diff_h);
                    this.$set(this.timer, 'i', diff_i);
                    this.$set(this.timer, 's', diff_s);
                } else {
                    // あと
                    console.log('終了');
                    this.$set(this.countdown, '_passed', true);
                    // window.cancelAnimationFrame(countdown_anime_request)
                }
            },

        }
    });

    function countdown_update(timestamp) {
        countdown_frame_cnt++;
        if (countdown_frame_cnt % countdown_interval == countdown_interval-1) {
            countdown_frame_cnt = 0;
            countdown_vueapp.updateTime()
        }
        if(countdown_vueapp.countdown._passed === true){
            window.cancelAnimationFrame(countdown_anime_request)
        }else{
            countdown_anime_request = window.requestAnimationFrame(countdown_update);
        }
    }
    countdown_anime_request = window.requestAnimationFrame(countdown_update);
</script>



</body>
</html>